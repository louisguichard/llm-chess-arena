<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Chess Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Use 'class' strategy for dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script>
        // On page load, apply theme from local storage to avoid FOUC (Light/Dark only)
        (function() {
            try {
                const saved = localStorage.getItem('theme') || 'light';
                document.documentElement.classList.toggle('dark', saved === 'dark');
            } catch (e) {}
        })();
    </script>
    <style>
        /* Ensure chess pieces keep their intended colors in dark mode */
        .dark .piece-black { color: #111; }
        .dark .piece-white { color: #fff; text-shadow: 0 0 1px #000; }
        /* Instant tooltips using data-tooltip */
        .has-tooltip { position: relative; }
        .has-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 0.75rem;
            top: 0;
            transform: translateY(-100%);
            background: rgba(0,0,0,0.85);
            color: #fff;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
        }
        .has-tooltip:hover::after { opacity: 1; }
    </style>
    
    <!-- SEO -->
    <meta name="description" content="The AI chess leaderboard. Pick your match, watch the battle, follow live rankings.">
    <meta name="keywords" content="AI chess, LLM chess, chess AI, chess battle, leaderboard, live rankings, Elo, OpenRouter, GPT chess, chess arena">
    <meta name="robots" content="index,follow">
    <link rel="canonical" href="{{ request.url }}">

    <!-- Open Graph (LinkedIn, Facebook) -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="LLM Chess Arena">
    <meta property="og:title" content="LLM Chess Arena">
    <meta property="og:description" content="The AI chess leaderboard. Pick your match, watch the battle, follow live rankings.">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:image" content="{{ url_for('preview_image', _external=True) }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="LLM Chess Arena">
    <meta name="twitter:description" content="The AI chess leaderboard. Pick your match, watch the battle, follow live rankings.">
    <meta name="twitter:image" content="{{ url_for('preview_image', _external=True) }}">
    <meta name="theme-color" content="#16a34a">
    {% block head %}{% endblock %}
</head>
<body class="bg-gray-100 dark:bg-zinc-950 text-gray-900 dark:text-gray-100 font-sans">
    <header class="sticky top-0 z-40 w-full backdrop-blur-sm bg-white/95 dark:bg-zinc-900/95 border-b border-gray-200/70 dark:border-zinc-800/70">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="grid grid-cols-[1fr_auto] md:grid-cols-[auto_1fr_auto] items-center h-16">
            <div class="flex items-center gap-3 justify-self-start">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="h-7 w-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/>
                <line x1="13" x2="19" y1="19" y2="13"/>
                <line x1="16" x2="20" y1="16" y2="20"/>
                <line x1="19" x2="21" y1="21" y2="19"/>
                <polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"/>
                <line x1="5" x2="9" y1="14" y2="18"/>
                <line x1="7" x2="4" y1="17" y2="20"/>
                <line x1="3" x2="5" y1="19" y2="21"/>
              </svg>
              <span class="font-bold text-lg sm:text-xl tracking-tight whitespace-nowrap truncate max-w-[60vw]">LLM Chess Arena</span>
              <span class="hidden sm:inline-flex items-center rounded-full bg-green-100/70 dark:bg-green-900/40 px-2 py-0.5 text-[10px] font-medium text-green-700 dark:text-green-300 border border-green-200/70 dark:border-green-800/60">Preview</span>
            </div>

            <nav class="hidden md:flex items-center gap-1 justify-self-center rounded-full bg-white/80 dark:bg-zinc-800/80 border border-gray-200/70 dark:border-zinc-700/60 px-1.5 py-1 shadow-sm">
              <button data-page="battle" class="nav-link px-4 py-2 rounded-full text-sm font-medium transition-colors text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/30 hover:text-green-700 dark:hover:text-green-300">Battle</button>
              <button data-page="leaderboard" class="nav-link px-4 py-2 rounded-full text-sm font-medium transition-colors text-gray-600 dark:text-gray-300 hover:bg-green-50 dark:hover:bg-green-900/30 hover:text-green-700 dark:hover:text-green-300">Leaderboard</button>
            </nav>

            <div class="flex items-center gap-2 justify-self-end">
              <button id="theme-toggle" type="button" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm border border-gray-200/70 dark:border-zinc-700/60 bg-white/60 dark:bg-zinc-800/60 text-gray-600 dark:text-gray-300 hover:bg-green-50/80 dark:hover:bg-zinc-700/60 shadow-sm">
                <i id="icon-light" data-lucide="sun" class="w-4 h-4 hidden"></i>
                <i id="icon-dark" data-lucide="moon" class="w-4 h-4"></i>
                <span class="hidden sm:inline" id="theme-label">Dark</span>
              </button>
              <a href="https://github.com/louisguichard/llm-chess-arena" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm border border-gray-200/70 dark:border-zinc-700/60 bg-white/60 dark:bg-zinc-800/60 text-gray-600 dark:text-gray-300 hover:bg-green-50/80 dark:hover:bg-zinc-700/60 shadow-sm">
                <i data-lucide="github" class="w-4 h-4"></i>
                <span class="hidden sm:inline">Source</span>
              </a>
              <button id="api-keys-btn" type="button" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-sm border border-gray-200/70 dark:border-zinc-700/60 bg-white/60 dark:bg-zinc-800/60 text-gray-600 dark:text-gray-300 hover:bg-green-50/80 dark:hover:bg-zinc-700/60 shadow-sm" title="Set your API keys to unlock expensive models">
                <i data-lucide="key" class="w-4 h-4"></i>
                <span class="hidden sm:inline">API keys</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>
    
    <main class="pb-16 md:pb-0">
        {% block content %}{% endblock %}
    </main>

    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-sm border-t border-gray-200 dark:border-zinc-800 p-2">
      <div class="flex justify-around">
         <button data-page="battle" class="mobile-nav-link flex flex-col items-center gap-1 p-2 rounded-lg w-full text-indigo-500"> <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg> <span class="text-xs font-medium">Battle</span> </button>
         <button data-page="leaderboard" class="mobile-nav-link flex flex-col items-center gap-1 p-2 rounded-lg w-full text-gray-500 dark:text-gray-400"> <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg> <span class="text-xs font-medium">Leaderboard</span> </button>
      </div>
    </nav>
    {% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
            const toggleBtn = document.getElementById('theme-toggle');
            const iconLight = document.getElementById('icon-light');
            const iconDark = document.getElementById('icon-dark');
            const label = document.getElementById('theme-label');

            function applyTheme(mode) {
                document.documentElement.classList.toggle('dark', mode === 'dark');
                // Show the next theme (sun when dark, moon when light)
                iconLight.classList.toggle('hidden', mode !== 'dark');
                iconDark.classList.toggle('hidden', mode !== 'light');
                if (label) label.textContent = mode === 'light' ? 'Dark' : 'Light';
            }

            function initTheme() {
                const stored = localStorage.getItem('theme') || 'light';
                applyTheme(stored);
            }

            initTheme();

            toggleBtn.addEventListener('click', () => {
                const current = localStorage.getItem('theme') || 'light';
                const next = current === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', next);
                applyTheme(next);
            });

            // Simple inline modal for API keys
            const apiBtn = document.getElementById('api-keys-btn');
            function ensureApiDialog() {
                let dlg = document.getElementById('api-keys-dialog');
                if (dlg) return dlg;
                dlg = document.createElement('div');
                dlg.id = 'api-keys-dialog';
                dlg.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4 hidden';
                dlg.innerHTML = `
                  <div class="w-full max-w-md rounded-xl border border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 shadow-xl">
                    <div class="p-4 border-b border-gray-200 dark:border-zinc-700 flex items-center justify-between">
                      <h3 class="font-semibold">API keys</h3>
                      <button id="api-keys-close" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">✕</button>
                    </div>
                    <div class="p-4 space-y-3">
                      <div>
                        <label class="block text-sm mb-1">OpenRouter API key</label>
                        <input id="input-openrouter" type="password" class="w-full px-3 py-2 rounded-md border border-gray-300 dark:border-zinc-700 bg-white dark:bg-zinc-800" placeholder="sk-or-v1-..." />
                        <p class="text-xs text-gray-500 mt-1">Used for all the expensive models, except Grok 4.</p>
                      </div>
                      <div>
                        <label class="block text-sm mb-1">xAI (Grok) API key</label>
                        <input id="input-grok" type="password" class="w-full px-3 py-2 rounded-md border border-gray-300 dark:border-zinc-700 bg-white dark:bg-zinc-800" placeholder="xai-..." />
                        <p class="text-xs text-gray-500 mt-1">Used for Grok 4 only (not Grok 3).</p>
                      </div>
                      <div class="mt-2">
                        <p class="text-xs font-semibold text-gray-600 dark:text-gray-300">Important notes</p>
                        <ul class="list-disc pl-5 mt-1 space-y-1 text-xs text-gray-500">
                          <li>Basic models never use your API keys — only expensive models do.</li>
                          <li>Your API keys are stored locally in your browser and are sent to the server only when running an expensive model. They never persist server-side.</li>
                          <li>GPT-5 can only be used via OpenRouter if you have previously connected your OpenAI account in your OpenRouter settings (Settings → Providers).</li>
                        </ul>
                      </div>
                    </div>
                    <div class="p-4 border-t border-gray-200 dark:border-zinc-700 flex items-center justify-end gap-2">
                      <button id="api-keys-clear" class="px-3 py-1.5 rounded-md border border-gray-200 dark:border-zinc-700">Clear</button>
                      <button id="api-keys-save" class="px-3 py-1.5 rounded-md bg-green-600 text-white">Save</button>
                    </div>
                  </div>
                `;
                document.body.appendChild(dlg);
                return dlg;
            }

            function getKeys() {
                let a = '';
                let b = '';
                try { a = localStorage.getItem('user_openrouter_api_key') || ''; } catch(e) {}
                try { b = localStorage.getItem('user_grok_api_key') || ''; } catch(e) {}
                return { openrouter: a, grok: b };
            }

            function setKeys(a, b) {
                try {
                    if (a) localStorage.setItem('user_openrouter_api_key', a); else localStorage.removeItem('user_openrouter_api_key');
                    if (b) localStorage.setItem('user_grok_api_key', b); else localStorage.removeItem('user_grok_api_key');
                } catch(e) {}
            }

            function updateExpensiveAvailability() {
                const keys = getKeys();
                const liList = Array.from(document.querySelectorAll('.player-selector-list .llm-option'));
                document.querySelectorAll('.player-selector-list .llm-option').forEach(li => {
                    const isExpensive = (li.dataset.expensive === 'true');
                    if (!isExpensive) return;
                    const modelId = li.dataset.llmId || '';
                    const needsGrok = modelId === 'x-ai/grok-4';
                    const hasKey = needsGrok ? !!keys.grok : !!keys.openrouter;
                    const nameSpan = li.querySelector('span.block.truncate');
                    if (hasKey) {
                        // enable
                        li.dataset.deactivated = 'false';
                        li.classList.remove('text-gray-400', 'dark:text-zinc-500', 'dark:text-zinc-600', 'cursor-default', 'cursor-not-allowed', 'has-tooltip');
                        li.classList.add('text-black', 'dark:text-gray-100', 'cursor-pointer', 'hover:bg-green-50', 'dark:hover:bg-green-900/20', 'hover:text-green-700', 'dark:hover:text-green-300');
                        li.removeAttribute('data-tooltip');
                        if (nameSpan) {
                            nameSpan.classList.remove('text-gray-400', 'dark:text-zinc-500');
                            nameSpan.classList.add('text-black', 'dark:text-gray-100');
                        }
                    } else {
                        // keep disabled
                        li.dataset.deactivated = 'true';
                        li.classList.add('text-gray-400', 'dark:text-zinc-500', 'cursor-default', 'cursor-not-allowed', 'has-tooltip');
                        li.classList.remove('text-black', 'dark:text-gray-100', 'cursor-pointer', 'hover:bg-green-50', 'dark:hover:bg-green-900/20', 'hover:text-green-700', 'dark:hover:text-green-300');
                        li.setAttribute('data-tooltip', needsGrok ? 'Requires xAI (Grok) API key' : 'Requires OpenRouter API key');
                        if (nameSpan) {
                            nameSpan.classList.add('text-gray-400', 'dark:text-zinc-500');
                            nameSpan.classList.remove('text-black', 'dark:text-gray-100');
                        }
                    }
                });

                // Reorder: keep original order, but move locked items (deactivated or expensive without key) to the end
                try {
                    const groups = Array.from(document.querySelectorAll('.player-selector-list'));
                    groups.forEach(ul => {
                        const items = Array.from(ul.querySelectorAll('.llm-option'));
                        // Capture original order indices once
                        items.forEach((li, idx) => {
                            if (!li.dataset.initialIndex) li.dataset.initialIndex = String(idx);
                        });
                        const active = [];
                        const inactive = [];
                        items.forEach(li => {
                            const isExpensive = (li.dataset.expensive === 'true');
                            const modelId = li.dataset.llmId || '';
                            const needsGrok = modelId === 'x-ai/grok-4';
                            const hasKey = needsGrok ? !!keys.grok : !!keys.openrouter;
                            const isTrulyDeactivated = (!isExpensive) && (li.dataset.deactivated === 'true');
                            const isLocked = (isExpensive && !hasKey) || isTrulyDeactivated;
                            if (isLocked) inactive.push(li); else active.push(li);
                        });
                        active.sort((a, b) => Number(a.dataset.initialIndex) - Number(b.dataset.initialIndex));
                        inactive.sort((a, b) => Number(a.dataset.initialIndex) - Number(b.dataset.initialIndex));
                        active.forEach(li => ul.appendChild(li));
                        inactive.forEach(li => ul.appendChild(li));
                    });
                } catch (e) {}
            }

            apiBtn.addEventListener('click', () => {
                const dlg = ensureApiDialog();
                const keys = getKeys();
                const inA = dlg.querySelector('#input-openrouter');
                const inB = dlg.querySelector('#input-grok');
                inA.value = keys.openrouter || '';
                inB.value = keys.grok || '';
                dlg.classList.remove('hidden');
            });

            document.addEventListener('click', (e) => {
                const dlg = document.getElementById('api-keys-dialog');
                if (!dlg || dlg.classList.contains('hidden')) return;
                const isClose = e.target && (e.target.id === 'api-keys-close');
                const isSave = e.target && (e.target.id === 'api-keys-save');
                const isClear = e.target && (e.target.id === 'api-keys-clear');
                if (isClose) {
                    dlg.classList.add('hidden');
                } else if (isSave) {
                    const a = dlg.querySelector('#input-openrouter').value.trim();
                    const b = dlg.querySelector('#input-grok').value.trim();
                    setKeys(a, b);
                    dlg.classList.add('hidden');
                    updateExpensiveAvailability();
                    // Re-open menu if user had it open to reflect changes immediately
                    try {
                        document.querySelectorAll('.player-selector-button').forEach(btn => {
                            const ul = btn.parentElement && btn.parentElement.querySelector('.player-selector-list');
                            if (ul && !ul.classList.contains('hidden')) {
                                // force refresh styles
                                ul.classList.add('hidden');
                                setTimeout(() => { ul.classList.remove('hidden'); }, 0);
                            }
                        });
                    } catch (e2) {}
                } else if (isClear) {
                    setKeys('', '');
                    dlg.querySelector('#input-openrouter').value = '';
                    dlg.querySelector('#input-grok').value = '';
                    updateExpensiveAvailability();
                }
            });

            // Expose a minimal API to other scripts
            window.__arenaKeys = {
                get: getKeys
            };

            // Initial pass to reflect keys availability
            setTimeout(updateExpensiveAvailability, 0);

            // Refresh availability each time the model dropdown is opened
            document.addEventListener('click', (e) => {
                const btn = e.target && e.target.closest && e.target.closest('.player-selector-button');
                if (btn) {
                    setTimeout(updateExpensiveAvailability, 0);
                }
            });
        });
    </script>
    {% endblock %}
</body>
</html>
